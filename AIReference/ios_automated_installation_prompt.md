# iOS 真机一键安装自动化 Prompt

## 📱 自动化识别与执行逻辑

当检测到以下任一需求场景时，**自动执行 iOS 真机一键安装流程**：

### 触发场景（满足任一即触发）

1. **用户明确提及真机安装**
   - "安装到真机"
   - "部署到 iPhone"
   - "在设备上运行"
   - "ios-deploy"
   - "真机调试"

2. **用户需要解决安装问题**
   - "安装失败"
   - "无法启动"
   - "证书问题"
   - "部署错误"

3. **用户希望自动化构建安装**
   - "一键安装"
   - "自动化部署"
   - "无人值守安装"
   - "脚本安装"

---

## 🚀 自动化执行流程

### 步骤 1：前置检查（并行执行）

```bash
# 1.1 检查设备连接状态
idevice_id -l

# 1.2 检查脚本存在性
ls -lh scripts/install_to_device.sh

# 1.3 检查项目根目录
pwd
```

**失败处理**：
- 设备未连接 → 提示用户连接设备，等待 10 秒后重试（最多 3 次）
- 脚本不存在 → 检查 scripts 目录，确认是否需要创建
- 路径错误 → 使用绝对路径

---

### 步骤 2：执行安装脚本

```bash
# 使用绝对路径执行脚本（从项目根目录）
./scripts/install_to_device.sh
```

**预期输出包含**：
- ✅ 设备检查通过
- ✅ 项目清理完成
- ✅ 依赖更新成功
- ✅ 构建成功
- ✅ 部署成功

---

### 步骤 3：读取安装摘要

脚本执行完成后，自动读取最新生成的摘要报告：

```bash
# 找到最新的安装摘要文件
LATEST_SUMMARY=$(ls -t Saved/Logs/installation_summary_*.log | head -1)
cat "$LATEST_SUMMARY"
```

**摘要内容应包含**：
- 构建耗时
- 应用路径
- Bundle Identifier
- 设备信息
- 安装状态

---

### 步骤 4：日志文件管理

所有日志自动保存到以下路径（已排除 Git 提交）：

```
Saved/Logs/
├── build_YYYYMMDD_HHMMSS.log        # 构建日志
├── install_YYYYMMDD_HHMMSS.log      # 安装日志
└── installation_summary_YYYYMMDD_HHMMSS.log  # 安装摘要
```

**日志清理建议**：
- 保留最近 10 个日志文件
- 超过 30 天的日志自动删除
- 单个日志文件超过 10MB 时轮转

---

## ⚠️ 关键注意事项

### 1. 开发者证书信任（必须手动操作）

**这是 Apple 的系统级安全限制，无法自动化完成**

**用户必须手动操作**：
1. 首次启动应用时，系统会提示"不受信任的开发者"
2. 进入 **设置 → 通用 → VPN 与设备管理**
3. 找到开发者证书，点击"信任 [开发者名称]"
4. 再次启动应用

**自动化提示**：
在脚本输出和摘要报告中，必须包含清晰的信任指引：

```markdown
⚠️ 重要提示：首次启动需要在设备上信任开发者证书

请按以下步骤操作：
1. 在设备上打开"设置"
2. 进入"通用" → "VPN 与设备管理"
3. 找到开发者证书，点击"信任"
4. 返回桌面，再次启动应用

这是 Apple 的安全机制，无法通过脚本自动化完成。
```

---

### 2. 免费账号限制

- **7天有效期**：应用证书 7 天后失效
- **每次需重新构建**：过期后需要重新运行脚本
- **一台设备**：每个免费账号最多注册一台设备

**建议**：对于开发调试场景，免费账号已足够；对于团队协作或正式发布，考虑付费账号。

---

### 3. 超时与重试策略

| 操作 | 超时时间 | 重试次数 | 替代方案 |
|------|---------|---------|---------|
| 设备检测 | 10 秒 | 3 次 | 等待用户手动连接 |
| 项目清理 | 30 秒 | 2 次 | 手动删除 |
| 依赖更新 | 60 秒 | 2 次 | 跳过更新警告 |
| 构建 | 5 分钟 | 1 次 | 检查错误日志 |
| 部署 | 2 分钟 | 2 次 | 使用 Xcode 手动部署 |

---

## 🔍 故障排查指南

### 常见问题 1：找不到设备

**症状**：
```
❌ 未找到连接的 iOS 设备
```

**排查步骤**：
1. 确认设备已连接并解锁
2. 检查 USB 线缆是否正常
3. 运行 `idevice_id -l` 确认设备 ID
4. 在 iTunes 中确认设备信任状态

**自动处理**：
```bash
# 提示用户检查设备
echo "请确认设备已连接并解锁"
sleep 10
# 重试检测
```

---

### 常见问题 2：构建失败

**症状**：
```
❌ 构建失败，请检查构建日志
```

**排查步骤**：
1. 读取构建日志：`Saved/Logs/build_*.log`
2. 检查常见错误：
   - 依赖问题 → 运行 `flutter pub get`
   - 签名问题 → 检查 Apple ID 配置
   - 证书过期 → 重新登录 Apple ID

**自动处理**：
```bash
# 检查构建日志尾部
tail -100 Saved/Logs/build_*.log
# 提供针对性建议
```

---

### 常见问题 3：部署失败

**症状**：
```
❌ 部署失败，请检查安装日志
```

**排查步骤**：
1. 读取安装日志：`Saved/Logs/install_*.log`
2. 检查常见错误：
   - 设备空间不足 → 清理设备空间
   - 权限问题 → 检查开发者配置
   - 设备繁忙 → 等待后重试

**自动处理**：
```bash
# 重试部署
./scripts/install_to_device.sh --retry
```

---

### 常见问题 4：应用无法启动

**症状**：
安装成功，但点击图标无法启动

**最可能原因**：
**未信任开发者证书**（这是最常见的情况）

**解决方案**：
1. 提示用户按照步骤手动信任证书
2. 如果已信任仍无法启动，检查设备日志
3. 考虑重新构建安装

**自动处理**：
```bash
# 在摘要中高亮显示信任指引
echo "⚠️ 99% 的情况是未信任开发者证书"
echo "请按照上述步骤手动信任"
```

---

## 📋 完整执行脚本模板

当自动执行时，按以下模板输出：

```markdown
## 🚀 开始 iOS 真机一键安装

### 📱 检测到的需求
[用户原始需求描述]

### 🔧 执行步骤

#### Step 1: 环境检查
- ✅ 设备已连接：iPhone [型号]
- ✅ 脚本就绪：scripts/install_to_device.sh
- ✅ 项目路径正确

#### Step 2: 执行安装脚本
[执行命令]

#### Step 3: 安装结果
[粘贴安装摘要]

#### Step 4: 后续操作
[包含开发者证书信任指引]

---

### 📁 日志文件位置
- 构建日志：`Saved/Logs/build_[timestamp].log`
- 安装日志：`Saved/Logs/install_[timestamp].log`
- 安装摘要：`Saved/Logs/installation_summary_[timestamp].log`
```

---

## 🎯 成功标准

满足以下任一条件即视为安装成功：

1. **脚本执行完成**
   - 安装摘要显示 "✅ 应用安装成功"
   - 设备上可见应用图标

2. **应用可启动**
   - 用户信任开发者证书后可正常启动
   - 首屏正常显示

3. **日志记录完整**
   - 构建日志保存成功
   - 安装日志保存成功
   - 摘要报告生成成功

**不要求**：
- 不要求应用立即启动（可能需要手动信任证书）
- 不要求所有功能正常（安装 ≠ 功能测试）

---

## 🔄 持续优化

### 自动改进触发条件

当满足以下条件时，自动优化脚本：

1. **连续 3 次超时**
   - 检测到某步骤经常超时
   - 自动优化该步骤的实现

2. **出现新的错误模式**
   - 收集到新的错误日志
   - 在脚本中添加错误检测和处理

3. **用户反馈改进**
   - 用户提出优化建议
   - 自动集成到脚本中

### 优化方向

- 🚀 缩短构建时间
- 📊 改进错误提示
- 🛡️ 增强稳定性
- 📝 完善日志记录

---

## 📚 相关文档

- [安装脚本](/Users/shuchangliu/Library/CloudStorage/OneDrive-个人/文档/Project/Flutter/resonate/scripts/install_to_device.sh)
- [日志迁移总结](/Users/shuchangliu/Library/CloudStorage/OneDrive-个人/文档/Project/Flutter/resonate/AIReference/log_path_migration_summary.md)
- [Saved 目录说明](/Users/shuchangliu/Library/CloudStorage/OneDrive-个人/文档/Project/Flutter/resonate/Saved/README.md)
- [开发者证书信任指南](/Users/shuchangliu/Library/CloudStorage/OneDrive-个人/文档/Project/Flutter/resonate/AIReference/certificate_trust_guide.md)

---

## ✅ 自动化执行检查清单

每次执行前，自动确认以下项目：

- [ ] 识别到用户需求属于真机安装场景
- [ ] 确认设备已连接
- [ ] 脚本路径正确
- [ ] 日志目录存在（Saved/Logs/）
- [ ] .gitignore 已配置排除 Saved/
- [ ] 准备好提供开发者证书信任指引
- [ ] 明确成功标准
- [ ] 准备好生成详细报告

---

## 🎯 核心原则

1. **自动识别，无需用户明确指示**
2. **并行执行，提高效率**
3. **详细记录，便于排查**
4. **友好提示，降低用户负担**
5. **无人值守，自动化完成**
